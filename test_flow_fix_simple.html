<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowä¿®å¤ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }

        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .success {
            color: #28a745;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .warning {
            color: #ffc107;
            font-weight: bold;
        }

        .info {
            color: #17a2b8;
            font-weight: bold;
        }

        /* ç®€åŒ–çš„Flowæ ·å¼ */
        .flow-display-container {
            margin: 20px 0;
            border: 2px solid #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 15px;
        }

        .execution-phase-header {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .execution-phase-title {
            margin: 0;
            color: #1976d2;
            font-weight: bold;
        }

        .flow-section {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .flow-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .flow-section pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 0;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .flow-step {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .flow-step.running {
            border-left: 4px solid #007bff;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .step-number {
            background: #007bff;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .step-title {
            flex: 1;
            font-weight: 500;
        }

        .step-status {
            font-size: 18px;
        }
    </style>
</head>

<body>
    <h1>Flowä¿®å¤ç®€å•æµ‹è¯•</h1>

    <div class="test-section">
        <h2>æµ‹è¯•FlowDisplayManager</h2>
        <button onclick="testFlowManager()">æµ‹è¯•Flowç®¡ç†å™¨</button>
        <button onclick="testEventHandling()">æµ‹è¯•äº‹ä»¶å¤„ç†</button>
        <div class="log" id="test-log"></div>
    </div>

    <div class="test-section">
        <h2>Flowæ˜¾ç¤ºåŒºåŸŸ</h2>
        <div id="flow-area"></div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // ç®€åŒ–çš„FlowDisplayManager
        class SimpleFlowDisplayManager {
            constructor() {
                this.flowData = { plan: null, steps: [], summary: null, currentStepIndex: -1 };
                this.containers = [];
                this.currentContainer = null;
                this.executionPhase = 0;
                log('SimpleFlowDisplayManageråˆ›å»ºæˆåŠŸ', 'success');
            }

            resetDataOnly() {
                this.flowData = { plan: null, steps: [], summary: null, currentStepIndex: -1 };
                log('æ•°æ®é‡ç½®å®Œæˆ', 'info');
            }

            initContainer() {
                const container = document.createElement('div');
                container.className = 'flow-display-container';

                this.executionPhase++;
                const phaseHeader = document.createElement('div');
                phaseHeader.className = 'execution-phase-header';
                phaseHeader.innerHTML = `<h5 class="execution-phase-title">æ‰§è¡Œé˜¶æ®µ ${this.executionPhase}</h5>`;
                container.appendChild(phaseHeader);

                // æ·»åŠ å„ä¸ªåŒºåŸŸ
                container.innerHTML += `
                    <div class="flow-section" id="plan-section" style="display: none;">
                        <h4>ğŸ“‹ æ‰§è¡Œè®¡åˆ’</h4>
                        <div id="plan-content"></div>
                    </div>
                    <div class="flow-section" id="steps-section" style="display: none;">
                        <h4>ğŸ”„ æ‰§è¡Œæ­¥éª¤</h4>
                        <div id="steps-content"></div>
                    </div>
                    <div class="flow-section" id="summary-section" style="display: none;">
                        <h4>ğŸ“ æ‰§è¡Œæ€»ç»“</h4>
                        <div id="summary-content"></div>
                    </div>
                `;

                this.containers.push(container);
                this.currentContainer = container;
                log(`å®¹å™¨åˆ›å»ºæˆåŠŸï¼Œæ‰§è¡Œé˜¶æ®µ: ${this.executionPhase}`, 'success');
                return container;
            }

            createNewExecutionPhase() {
                return this.initContainer();
            }

            handlePlanEvent(text) {
                log(`å¤„ç†Planäº‹ä»¶: ${text}`, 'info');
                this.flowData.plan = text;

                const planSection = document.getElementById('plan-section');
                const planContent = document.getElementById('plan-content');

                if (planSection && planContent) {
                    planContent.innerHTML = `<pre>${text}</pre>`;
                    planSection.style.display = 'block';
                    log('è®¡åˆ’åŒºåŸŸå·²æ˜¾ç¤º', 'success');
                } else {
                    log('æ‰¾ä¸åˆ°è®¡åˆ’åŒºåŸŸå…ƒç´ ', 'error');
                }
            }

            handleStepEventByContent(text) {
                log(`å¤„ç†Stepäº‹ä»¶: ${text}`, 'info');

                if (text.includes('å¼€å§‹æ‰§è¡Œæ­¥éª¤')) {
                    const stepNumber = this.flowData.steps.length + 1;
                    const stepTitle = text.replace('å¼€å§‹æ‰§è¡Œæ­¥éª¤', '').trim();

                    const step = {
                        number: stepNumber,
                        title: stepTitle,
                        status: 'running'
                    };

                    this.flowData.steps.push(step);
                    this.currentStepIndex = stepNumber - 1;

                    this.updateStepsDisplay();
                    log(`æ–°æ­¥éª¤å¼€å§‹: ${stepTitle}`, 'success');
                } else if (text.includes('æ­¥éª¤æ‰§è¡Œå®Œæˆ')) {
                    if (this.currentStepIndex >= 0 && this.currentStepIndex < this.flowData.steps.length) {
                        this.flowData.steps[this.currentStepIndex].status = 'completed';
                        this.updateStepsDisplay();
                        log('æ­¥éª¤æ‰§è¡Œå®Œæˆ', 'success');
                    }
                }
            }

            handleDetailEvent(type, text) {
                log(`å¤„ç†Detailäº‹ä»¶: ${type} - ${text}`, 'info');

                if (this.currentStepIndex >= 0 && this.currentStepIndex < this.flowData.steps.length) {
                    const step = this.flowData.steps[this.currentStepIndex];
                    if (!step.details) step.details = [];
                    step.details.push({ type, content: text });
                    this.updateStepsDisplay();
                    log(`${type}äº‹ä»¶å·²æ·»åŠ åˆ°æ­¥éª¤${step.number}`, 'success');
                }
            }

            handleSummaryEvent(text) {
                log(`å¤„ç†Summaryäº‹ä»¶: ${text}`, 'info');
                this.flowData.summary = text;

                const summarySection = document.getElementById('summary-section');
                const summaryContent = document.getElementById('summary-content');

                if (summarySection && summaryContent) {
                    summaryContent.innerHTML = `<pre>${text}</pre>`;
                    summarySection.style.display = 'block';
                    log('æ€»ç»“åŒºåŸŸå·²æ˜¾ç¤º', 'success');
                } else {
                    log('æ‰¾ä¸åˆ°æ€»ç»“åŒºåŸŸå…ƒç´ ', 'error');
                }
            }

            addInteractionMarker(text) {
                log(`æ·»åŠ äº¤äº’æ ‡è®°: ${text}`, 'info');
            }

            updateStepsDisplay() {
                const stepsSection = document.getElementById('steps-section');
                const stepsContent = document.getElementById('steps-content');

                if (!stepsSection || !stepsContent) {
                    log('æ‰¾ä¸åˆ°æ­¥éª¤åŒºåŸŸå…ƒç´ ', 'error');
                    return;
                }

                stepsContent.innerHTML = '';

                this.flowData.steps.forEach(step => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = `flow-step ${step.status}`;

                    stepDiv.innerHTML = `
                        <div class="step-header">
                            <div class="step-number">${step.number}</div>
                            <div class="step-title">${step.title}</div>
                            <div class="step-status">
                                ${step.status === 'running' ? 'ğŸ”„' : step.status === 'completed' ? 'âœ…' : 'âŒ'}
                            </div>
                        </div>
                        ${step.details && step.details.length > 0 ?
                            '<div class="step-details">' +
                            step.details.map(detail => `
                                <div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
                                    <strong>${detail.type === 'think' ? 'ğŸ¤”' : 'âš¡'}</strong> ${detail.content}
                                </div>
                            `).join('') + '</div>' : ''}
                    `;

                    stepsContent.appendChild(stepDiv);
                });

                stepsSection.style.display = 'block';
                log('æ­¥éª¤æ˜¾ç¤ºå·²æ›´æ–°', 'success');
            }
        }

        // å…¨å±€å˜é‡
        let flowManager = null;
        let flowArea = null;

        // æµ‹è¯•Flowç®¡ç†å™¨
        function testFlowManager() {
            log('å¼€å§‹æµ‹è¯•Flowç®¡ç†å™¨', 'info');

            try {
                flowManager = new SimpleFlowDisplayManager();
                const container = flowManager.initContainer();
                flowArea.appendChild(container);
                log('Flowç®¡ç†å™¨æµ‹è¯•æˆåŠŸ', 'success');

            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
                console.error('Flowç®¡ç†å™¨æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•äº‹ä»¶å¤„ç†
        function testEventHandling() {
            if (!flowManager) {
                log('è¯·å…ˆåˆ›å»ºFlowç®¡ç†å™¨', 'warning');
                return;
            }

            log('å¼€å§‹æµ‹è¯•äº‹ä»¶å¤„ç†', 'info');

            // æ¨¡æ‹Ÿä¸€ç³»åˆ—äº‹ä»¶
            flowManager.handlePlanEvent('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è®¡åˆ’\nåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š\n1. éœ€æ±‚åˆ†æ\n2. æ–¹æ¡ˆè®¾è®¡\n3. å®æ–½æ‰§è¡Œ');

            flowManager.handleStepEventByContent('å¼€å§‹æ‰§è¡Œæ­¥éª¤ï¼šéœ€æ±‚åˆ†æ');
            flowManager.handleDetailEvent('think', 'æ€è€ƒç”¨æˆ·çš„å…·ä½“éœ€æ±‚...');
            flowManager.handleDetailEvent('act', 'å¼€å§‹æ”¶é›†å’Œåˆ†æéœ€æ±‚ä¿¡æ¯');
            flowManager.handleStepEventByContent('æ­¥éª¤æ‰§è¡Œå®Œæˆ');

            flowManager.handleStepEventByContent('å¼€å§‹æ‰§è¡Œæ­¥éª¤ï¼šæ–¹æ¡ˆè®¾è®¡');
            flowManager.handleDetailEvent('think', 'åŸºäºéœ€æ±‚è®¾è®¡è§£å†³æ–¹æ¡ˆ...');
            flowManager.handleDetailEvent('act', 'åˆ¶å®šè¯¦ç»†çš„å®æ–½æ–¹æ¡ˆ');
            flowManager.handleStepEventByContent('æ­¥éª¤æ‰§è¡Œå®Œæˆ');

            flowManager.handleSummaryEvent('æ‰§è¡Œæ€»ç»“ï¼š\nâœ… éœ€æ±‚åˆ†æå®Œæˆ\nâœ… æ–¹æ¡ˆè®¾è®¡å®Œæˆ\nğŸ“Š æ€»ä½“è¿›åº¦ï¼š100%');

            log('äº‹ä»¶å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            flowArea = document.getElementById('flow-area');
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>

</html>
