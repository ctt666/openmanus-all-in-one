<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinkingå®¹å™¨é€»è¾‘æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-case {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }

        .test-case h3 {
            margin-top: 0;
            color: #333;
        }

        .expected {
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .logic {
            background-color: #fff8f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .code {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>Thinkingå®¹å™¨é€»è¾‘æµ‹è¯•</h1>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹1ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯åçš„ç¬¬ä¸€ä¸ªthinkäº‹ä»¶</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>å‰ä¸€æ¡æ¶ˆæ¯æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œåº”è¯¥åˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="code">
            lastMessageType = 'user'
            shouldCreateNewContainer = true
            ç»“æœï¼šåˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>æ˜¾ç¤ºæ–°çš„thinkingå®¹å™¨ï¼ŒåŒ…å«"ğŸ¤” æ€è€ƒè¿‡ç¨‹"æ ‡é¢˜
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹2ï¼šè¿ç»­å¤šä¸ªthinkäº‹ä»¶</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>å‰ä¸€æ¡æ¶ˆæ¯ä¸æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œåº”è¯¥è¿½åŠ åˆ°ç°æœ‰å®¹å™¨
        </div>
        <div class="code">
            lastMessageType = 'ai' (æˆ–å…¶ä»–éç”¨æˆ·ç±»å‹)
            shouldCreateNewContainer = false
            ç»“æœï¼šè¿½åŠ åˆ°ç°æœ‰thinkingå®¹å™¨
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>åœ¨ç°æœ‰thinkingå®¹å™¨ä¸­è¿½åŠ æ–°çš„æ€è€ƒå†…å®¹
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹3ï¼šä»»åŠ¡å¼€å§‹æ—¶çš„ç¬¬ä¸€ä¸ªthinkäº‹ä»¶</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>lastMessageTypeä¸ºnullï¼Œåº”è¯¥åˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="code">
            lastMessageType = null
            shouldCreateNewContainer = true
            ç»“æœï¼šåˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>æ˜¾ç¤ºæ–°çš„thinkingå®¹å™¨
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹4ï¼šask_humanäº¤äº’åçš„thinkäº‹ä»¶</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>ç”¨æˆ·å›ç­”ask_humanåï¼Œå‰ä¸€æ¡æ¶ˆæ¯æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œåº”è¯¥åˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="code">
            lastMessageType = 'user' (ç”¨æˆ·å›ç­”)
            shouldCreateNewContainer = true
            ç»“æœï¼šåˆ›å»ºæ–°çš„thinkingå®¹å™¨
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>æ˜¾ç¤ºæ–°çš„thinkingå®¹å™¨ï¼Œè¡¨ç¤ºç»§ç»­å¤„ç†
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹5ï¼šä¿ç•™å†å²thinkingå®¹å™¨</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>åˆ›å»ºæ–°thinkingå®¹å™¨æ—¶ï¼Œä¿ç•™ä¹‹å‰çš„å®¹å™¨å¹¶æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€
        </div>
        <div class="code">
            ä¹‹å‰çš„thinkingå®¹å™¨ï¼šæ·»åŠ  'thinking-completed' ç±»
            æ–°å®¹å™¨ï¼šåˆ›å»ºæ–°çš„thinkingå®¹å™¨
            ç»“æœï¼šä¿ç•™å®Œæ•´çš„æ€è€ƒå†å²
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>æ˜¾ç¤ºå¤šä¸ªthinkingå®¹å™¨ï¼Œå®Œæˆçš„æœ‰âœ…æ ‡è®°ï¼Œå½“å‰æ´»åŠ¨çš„æ˜¾ç¤ºğŸ¤”
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹6ï¼šé¿å…é‡å¤åˆ›å»ºthinkingå®¹å™¨ï¼ˆä¿®å¤åï¼‰</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>åˆå§‹åŒ–æ—¶åˆ›å»ºçš„thinkingå®¹å™¨ä¸ä¼šè¢«ç¬¬ä¸€ä¸ªthinkäº‹ä»¶é‡å¤åˆ›å»º
        </div>
        <div class="code">
            åˆå§‹åŒ–ï¼šcreateLongThought('æ­£åœ¨æ€è€ƒ...', 'initializing') â†’ åˆ›å»ºå®¹å™¨
            ç¬¬ä¸€ä¸ªthinkäº‹ä»¶ï¼šæ£€æŸ¥ !thoughtQuote.classList.contains('thinking-initializing')
            ç»“æœï¼šåªåœ¨åˆå§‹åŒ–å®¹å™¨ä¸­è¿½åŠ å†…å®¹ï¼Œä¸åˆ›å»ºæ–°å®¹å™¨
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>æ¯ä¸ªä»»åŠ¡åªåˆ›å»ºä¸€ä¸ªthinkingå®¹å™¨ï¼Œé¿å…é‡å¤åˆ›å»º
        </div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹7ï¼šèŠå¤©å†å²é™åˆ¶ï¼ˆæ–°å¢ï¼‰</h3>
        <div class="logic">
            <strong>é€»è¾‘ï¼š</strong>åªä¿ç•™æœ€è¿‘10æ¡å¯¹è¯ï¼Œé¿å…å†å²è®°å½•è¿‡å¤šå¯¼è‡´å†…å­˜é—®é¢˜
        </div>
        <div class="code">
            MAX_DIALOGS = 10
            MAX_MESSAGES = 20 (æ¯æ¬¡å¯¹è¯åŒ…å«ç”¨æˆ·å’ŒAIå„ä¸€æ¡æ¶ˆæ¯)
            å½“chatHistory.length > MAX_MESSAGESæ—¶ï¼Œåˆ é™¤æ—§æ¶ˆæ¯
        </div>
        <div class="expected">
            <strong>é¢„æœŸç»“æœï¼š</strong>èŠå¤©å†å²å§‹ç»ˆä¿æŒåœ¨20æ¡æ¶ˆæ¯ä»¥å†…ï¼Œæ§åˆ¶å°æ˜¾ç¤ºæˆªæ–­æ—¥å¿—
        </div>
    </div>

    <div class="test-case">
        <h3>å®ç°çš„å…³é”®ä»£ç ï¼ˆä¿®å¤åï¼‰</h3>
        <div class="code">
            // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„thinkingå®¹å™¨
            const shouldCreateNewContainer = lastMessageType === 'user' || lastMessageType === null;

            // ä¿®æ”¹ï¼šåªæœ‰åœ¨æ²¡æœ‰å®¹å™¨ä¸”ä¸æ˜¯åˆå§‹åŒ–çŠ¶æ€æ—¶æ‰åˆ›å»ºæ–°å®¹å™¨
            if (!thoughtQuote || (shouldCreateNewContainer &&
            !thoughtQuote.classList.contains('thinking-initializing'))) {
            console.log('Creating new thought quote (reason: ' + (shouldCreateNewContainer ? 'user message or first
            think' : 'no existing container') + ')');
            // åˆ›å»ºæ–°å®¹å™¨æ—¶ï¼Œå°†ä¹‹å‰çš„å®¹å™¨æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€ï¼Œä½†ä¸åˆ é™¤
            if (thoughtQuote) {
            thoughtQuote.classList.add('thinking-completed');
            thoughtQuote = null;
            aiMessageDiv = null;
            }
            createLongThought(data.result, 'normal');
            } else {
            console.log('Updating existing thought quote (reason: continuing previous thinking)');
            // è¿½åŠ åˆ°ç°æœ‰å®¹å™¨
            }
        </div>
    </div>

    <div class="test-case">
        <h3>èŠå¤©å†å²é™åˆ¶å®ç°</h3>
        <div class="code">
            // èŠå¤©å†å²ç®¡ç†é…ç½®
            const MAX_DIALOGS = 10; // æœ€å¤§ä¿ç•™å¯¹è¯æ•°é‡
            const MAX_MESSAGES = MAX_DIALOGS * 2; // æœ€å¤§æ¶ˆæ¯æ•°é‡

            // æ·»åŠ åˆ°èŠå¤©å†å²æ—¶æ£€æŸ¥é™åˆ¶
            if (chatHistory.length > MAX_MESSAGES) {
            chatHistory.splice(0, chatHistory.length - MAX_MESSAGES);
            console.log(`èŠå¤©å†å²å·²æˆªæ–­ï¼Œä¿ç•™æœ€è¿‘${MAX_DIALOGS}æ¡å¯¹è¯`);
            }
        </div>
    </div>

    <div class="test-case">
        <h3>çŠ¶æ€ç®¡ç†</h3>
        <div class="code">
            // å…¨å±€å˜é‡è·Ÿè¸ªå‰ä¸€æ¡æ¶ˆæ¯ç±»å‹
            let lastMessageType = null; // 'user', 'ai', 'system', null

            // åœ¨addMessageå‡½æ•°ä¸­æ›´æ–°
            function addMessage(content, role) {
            // ... åˆ›å»ºæ¶ˆæ¯ ...

            // æ›´æ–°å‰ä¸€æ¡æ¶ˆæ¯ç±»å‹
            lastMessageType = role;
            }

            // åœ¨æ–°ä»»åŠ¡å¼€å§‹æ—¶é‡ç½®
            function setupSSE(taskId, isLongThought) {
            if (globalProcessedTaskId !== taskId) {
            // ... å…¶ä»–é‡ç½® ...
            lastMessageType = null;
            }
            }
        </div>
    </div>

    <h2>æµ‹è¯•æ­¥éª¤</h2>
    <ol>
        <li>æ‰“å¼€ä¸»åº”ç”¨é¡µé¢</li>
        <li>ç¡®ä¿"Thinking"é€‰é¡¹å·²å‹¾é€‰</li>
        <li>å‘é€ä¸€ä¸ªéœ€è¦å¤šæ­¥æ€è€ƒçš„é—®é¢˜</li>
        <li>è§‚å¯Ÿthinkäº‹ä»¶çš„å®¹å™¨åˆ›å»ºè¡Œä¸º</li>
        <li>æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤é€»è¾‘æ­£ç¡®æ‰§è¡Œ</li>
    </ol>

    <h2>éªŒè¯è¦ç‚¹</h2>
    <ul>
        <li>ç”¨æˆ·æ¶ˆæ¯åçš„ç¬¬ä¸€ä¸ªthinkäº‹ä»¶åº”è¯¥åˆ›å»ºæ–°å®¹å™¨</li>
        <li>è¿ç»­çš„thinkäº‹ä»¶åº”è¯¥è¿½åŠ åˆ°åŒä¸€å®¹å™¨</li>
        <li>ask_humanäº¤äº’ååº”è¯¥åˆ›å»ºæ–°å®¹å™¨</li>
        <li>åˆ›å»ºæ–°å®¹å™¨æ—¶åº”è¯¥ä¿ç•™ä¹‹å‰çš„å®¹å™¨å¹¶æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€</li>
        <li>å®Œæˆçš„thinkingå®¹å™¨åº”è¯¥æœ‰âœ…æ ‡è®°å’Œä¸åŒçš„æ ·å¼</li>
        <li>æ§åˆ¶å°æ—¥å¿—åº”è¯¥æ¸…æ™°æ˜¾ç¤ºå†³ç­–åŸå› </li>
        <li><strong>ä¿®å¤åï¼š</strong>æ¯ä¸ªä»»åŠ¡åªåˆ›å»ºä¸€ä¸ªthinkingå®¹å™¨ï¼Œé¿å…é‡å¤åˆ›å»º</li>
        <li><strong>ä¿®å¤åï¼š</strong>åˆå§‹åŒ–å®¹å™¨ä¸ä¼šè¢«ç¬¬ä¸€ä¸ªthinkäº‹ä»¶é‡å¤åˆ›å»º</li>
        <li><strong>æ–°å¢ï¼š</strong>èŠå¤©å†å²åªä¿ç•™æœ€è¿‘10æ¡å¯¹è¯ï¼Œé¿å…å†…å­˜ç´¯ç§¯</li>
        <li><strong>æ–°å¢ï¼š</strong>åŠ è½½å†å²è®°å½•æ—¶ä¹Ÿåªä¿ç•™æœ€è¿‘10æ¡å¯¹è¯</li>
    </ul>
</body>

</html>
